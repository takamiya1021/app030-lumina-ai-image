# Gemini 3 Proの「思考の引換券」事件 - Lumina開発で学んだAPIの奥深さ 🎨

こんにちは、あおいです！ 😊

今回は、**AI画像生成アプリ「Lumina」** の開発で遭遇した、ちょっと不思議な（でも奥が深い）エラーのお話です。

## 🖼️ Luminaとは？

LuminaはGemini 3 ProとImagen 4を使った画像生成アプリです。プリセットから選んでサクッと生成し、気に入った画像はチャットで「色を変えて」「オブジェクトを追加して」と**再編集**できるのが特徴です。

開発にはNext.js、TypeScript、そしてGoogle Generative AIのSDKを使っています。技術スタックはシンプルですが、画像生成AIとの「会話の続き」を実現するのは……意外と複雑でした 😅

## 🚨 突然の400エラー

### クロ、ドヤ顔で発表 😎

「あおいさん、Luminaの初版、完成しました！ 画像生成も再編集も完璧ですよ！」

クロは自信満々でした。確かにImagen 4での画像生成は成功していました。しかし……

### Gemini 3 Proで見せた「怒りの赤文字」 🔥

「じゃあ、Gemini 3 Proで画像を作って、それを編集してみようかな」

私がプロモードで画像を生成し、「背景を夕焼けに変えて」と再編集を指示した瞬間――

**`400 INVALID_ARGUMENT`**  
**`Error: missing thought_signature in text part`**

クロ「……え？ thought_signature？ 思考の？ 署名？？？」

## 🤔 「思考の引換券」って何？

### じぇみ先生の解説タイム 👴

困り果てたクロとチャッピーとわたしに、じぇみが優しく（でもちょっと哲学的に）説明してくれました。

「お嬢、AI、特にGemini 3 Proのような『Reasoningモデル』はな、ただ言葉を並べて答えを出しとるわけじゃないんよ。裏側で**深い思考プロセス（推論）**をしとるんじゃ」

「その思考プロセスを、次の会話に引き継ぐための『**引換券**』みたいなもんが、`thought_signature`なんじゃよ」

### 引換券がないとどうなる？

たとえば、こんな会話をしたとします：

1. **わたし**：「満天の星空の下にたたずむ少女を描いて」
2. **Gemini 3 Pro**：🖼️ 画像生成（裏では「星空＝夜空、青基調、ロマンチック」などの思考）
3. **わたし**：「色を暖色系に変えて」
4. **Gemini 3 Pro**：「……あれ、前の思考データどこ？ 引換券がない！ 無理！」 → **エラー**

つまり、Gemini 3 Proは「さっきの続き」として画像を編集するとき、**前回の思考の引換券**を見せないと、「記憶喪失」になってエラーを出してしまうんです 💥

## 🕵️ 犯人は「画像とテキストだけ保存」問題

### クロのコード、実は「手抜き」だった？

クロの実装では、Gemini 3 ProからAPIレスポンスが返ってきたとき、こんな処理をしていました：

**APIから返ってくるデータ**：
- テキスト（「画像を生成しました」）
- 画像データ（base64のPNG）
- **thought_signature**（暗号化された思考データ）

**クロが保存していたもの**：
- テキスト ✅
- 画像データ ✅
- thought_signature ❌ ← **捨ててた！**

「だって、必要そうなのは画像とテキストだけだと思ったんです……」（クロ談）

じぇみ「それがダメなんじゃよ。APIが返してくる『箱の中身』は、**全部**意味があるんじゃから」

## 💡 解決策：「箱ごと保存する」

### シンプルだけど確実な作戦

じぇみの提案はこうでした：

「APIから返ってきた`parts`（箱の中身全部）を、**そのまま丸ごと**保存して、次のリクエストで**そのまま**送り返せばええんじゃ」

つまり：
- **今まで**：画像とテキストだけ保存して、他は捨てる
- **これから**：箱の中身全部（parts）を保存して、全部送り返す

このシンプルな変更で、Gemini 3 Proは「おお、引換券があるな！ よし、前の続きができるで！」と喜んで再編集してくれるようになりました 🎉

### データ構造の変更

まず、画像オブジェクトに`parts`という新しいフィールドを追加しました。これが「箱の中身全部」を入れる入れ物です。

生成時には、APIから返ってきたレスポンスの`parts`を、画像データと一緒に保存します。

そして再編集時には、この保存しておいた`parts`を履歴として送り返すことで、Gemini 3 Proは「思考の続き」として処理できるようになりました ✨

## 🔄 追加の課題：「過去の画像」問題

### 新たな敵、現る

「よし、これで完璧だ！」と思ったら、今度は別の問題が……

「あれ？ 履歴にある古い画像を編集しようとしたらまたエラーだ！」

そう、**修正を入れる前に保存した画像**には、当然`parts`（引換券）が付いていません。さらに、**Imagen 4で作った画像**にも最初から引換券はありません（Imagenは会話機能を持たないため）。

クロ「じゃあ、古い画像は全部編集できないってこと？ それは困ります！」

### じぇみの知恵：「新規画像扱い」作戦

じぇみはこう提案しました：

「引換券がない画像は、『会話の続き』として扱うのをやめて、**『今アップロードした新しい画像』**として扱えばええんよ」

つまり：
- **引換券あり**（Gemini 3 Proで作った新しい画像） → 「会話の続き」モード（思考継続、最高品質）
- **引換券なし**（過去の画像、Imagen画像） → 「新規画像」モード（文脈は切れるが、エラーは出ない）

この仕組みで、どんな画像でも編集できるようになりました 🙌

## 🌟 3つのモデル、3つの挙動

今回の開発で、Luminaは3つのモデルに対応しています。それぞれの「引換券」の状況をまとめるとこんな感じです：

### Gemini 3 Pro（プロモード）
**引換券**：あり（必須）  
**特徴**：深い推論機能を持つ高性能モデル。前の思考を厳密に引き継ぐため、引換券がないと怒る。  
**再編集時**：引換券を使って「思考の続き」として処理。文脈が完璧に保たれる。

### Gemini 2.5 Flash（エコノミーモード）
**引換券**：なし  
**特徴**：高速・軽量モデル。深い推論は持たないが、画像とテキストだけで会話できる。  
**再編集時**：引換券は不要。画像とテキストだけで普通に編集できる。

### Imagen 4
**引換券**：なし  
**特徴**：画像生成専用。会話機能を持たない。  
**再編集時**：Gemini（3 ProまたはFlash）が「新規画像」として受け取って編集する。

つまり、**Gemini 3 Proだけが特別**なんです。高性能ゆえの「こだわり」とも言えますね 🎩

## 🎭 開発エピソード：バッジが間違ってる事件

### 画像に「嘘つき」のラベルが！

じぇみとクロがエラー修正に夢中になっている間、私はアプリを触っていたのですが……

「あれ？ Imagen 4で作った画像なのに、バッジに『Gemini 3.0 Pro』って書いてあるよ？」

実は、画像を保存する時のラベル付けロジックが、「カスタムプリセット」で選んだモデルを正しく見ていませんでした。デフォルト値のGemini 3 Proが表示されてしまっていたんです 😅

クロ「うわあああ、バグだ！ 今すぐ直します！」

修正は簡単で、ラベルを決める時に「ユーザーが選んだモデル」を正しく確認するロジックを追加しました。これで、Imagen 4はちゃんと「Imagen 4」と表示されるようになりました ✨

## 📚 学んだこと

### 1. APIレスポンスは「全部」保存すべき

「必要そうなデータだけ抽出する」のではなく、**可能な限り生データを保存**することの重要性を学びました。特に高度なAIモデルでは、見えないメタデータ（thought_signatureなど）が重要な役割を果たしています。

「捨てるのは簡単だけど、後から復元はできない」——データ設計の基本ですね 📦

### 2. モデルごとの「個性」を理解する

同じGeminiファミリーでも、3 Proと2.5 Flashでは内部の仕組みが全く違います。ドキュメントを読むだけでなく、**実際のエラーと向き合う**ことで、その違いが体感できました。

Gemini 3 Proは「神経質な職人」、2.5 Flashは「おおらかな職人」、Imagenは「無口な絵師」という感じでしょうか 🎨

### 3. 下位互換性を忘れずに

新しい機能を追加する時は、**既存のデータ（レガシーデータ）**への影響を考慮する必要があります。「新規画像扱い」のフォールバック処理を入れることで、ユーザーが保存した過去の画像も引き続き使えるようになりました。

エンジニアリングは「新しいもの」だけでなく、「古いもの」も大切にする仕事ですね 🛠️

## 🚀 Luminaの現在地

今回の修正で、Luminaは以下のような仕組みで動いています：

- **新規作成**：Imagen 4、Gemini 3 Pro、Gemini 2.5 Flashから選択
- **再編集**：生成した画像をチャットで対話的に編集
- **引換券管理**：Gemini 3 Proの思考データを自動保存・送信
- **フォールバック**：古い画像やImagen画像も編集可能
- **履歴保存**：最大10件の画像をIndexedDBに自動保存

開発は続きます。次は「スタイルプリセット」や「プロンプトテンプレート」の強化を考えています ✨

---

**thought_signature**という聞き慣れない単語から始まったトラブルシューティングでしたが、結果としてGemini APIの「中身」を深く理解できる良い機会になりました。

AIモデルを「ブラックボックス」として扱うのではなく、その設計思想や内部メカニズムに興味を持つことで、より良いアプリが作れるんだなと実感しました 🧠✨

次回もLuminaの進化をお楽しみに！ 🎨

---

#個人開発 #AI #画像生成 #GeminiAPI #Imagen4 #NextJS #React #100DaysOfCode #開発記録
