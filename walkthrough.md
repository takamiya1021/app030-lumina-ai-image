# Fix: Missing Thought Signature in Gemini 3 Pro Refinement

## Problem
Users encountered a `400 INVALID_ARGUMENT` error when trying to refine images generated with **Gemini 3 Pro**. The error message `Text part is missing a thought_signature` indicated that the model's reasoning context was lost during the refinement process.
Additionally, attempting to refine an image generated by other models (Gemini 2.5 Flash, Imagen 4) using **Gemini 3 Pro** caused the same error because those models do not output thought signatures.

## Root Cause Analysis
1.  **Missing Data in Generation**: The `generateContent` function was not returning the raw `parts` from the API response.
2.  **Aggressive Filtering**: The `refineContent` function was stripping `inlineData` (images) from the conversation history, removing the attached `thought_signature`.
3.  **Cross-Model Incompatibility**: History from non-3-Pro models lacks `thought_signature`. Passing this history to Gemini 3 Pro causes a validation error.

## Solution
1.  **Capture Raw Parts**: Updated `generateContent` to return full `parts`.
2.  **Preserve History**: Modified `refineContent` to keep all parts (including `inlineData`) for Gemini 3 Pro.
3.  **Strict Allowlist**: Implemented a **strict allowlist** for history items.
    -   Only history items explicitly identified as **"Gemini 3 Pro"** (via image metadata) are included in the conversation history sent to the API.
    -   All other items (Gemini 2.5 Flash, Imagen 4, text-only turns of unknown origin) are **skipped**.
    -   The **latest generated image** is always preserved and attached to the current request as a reference, enabling seamless cross-model editing without errors.

## Verification
-   **Automated Test**: Verified `parts` extraction with `verify_fix.ts`.
-   **Manual Verification**:
    1.  **Same Model**: Gen (3 Pro) -> Refine (3 Pro) = **Success** (History preserved).
    2.  **Cross Model**: Gen (2.5 Flash / Imagen 4) -> Refine (3 Pro) = **Success** (History reset, Image preserved).

## Changes
-   `services/geminiService.ts`: Updated `generateContent` and `refineContent` with strict allowlist logic.

## Status
-   [x] Fix Implemented
-   [x] Verified
-   [x] Deployed (Committed & Pushed)

## Deployment Log
-   **Date**: 2025-11-29
-   **Action**: Build & Push
-   **Status**: Success
-   **Commit**: `chore: build and update task status`
